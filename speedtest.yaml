- sensor:
    - name: "Internet Download"
      unique_id: speedtest_internet_download
      state: >
        {% set download = state_attr('sensor.speedtest_dados', 'download') %}
        {{ (download / 1000000) | round(0) if download else none }}
      unit_of_measurement: "Mbps"
      icon: mdi:download
      device_class: data_rate
      state_class: measurement

    - name: "Internet Upload"
      unique_id: speedtest_internet_upload
      state: >
        {% set upload = state_attr('sensor.speedtest_dados', 'upload') %}
        {{ (upload / 2000000) | round(0) if upload else none }}
      unit_of_measurement: "Mbps"
      icon: mdi:upload
      device_class: data_rate
      state_class: measurement

    - name: "Internet Ping"
      unique_id: speedtest_internet_ping
      state: >
        {% set ping = state_attr('sensor.speedtest_dados', 'ping') %}
        {{ (ping * 1000) | round(0) if ping else none }}
      unit_of_measurement: "ms"
      icon: mdi:speedometer
      device_class: duration
      state_class: measurement

    - name: "Speedtest Provedor"
      unique_id: speedtest_servidor_provedor
      state: >
        {% set server = state_attr('sensor.speedtest_dados', 'server') %}
        {{ server.sponsor if server and server.sponsor is defined else 'Desconhecido' }}
      icon: mdi:domain

    - name: "Speedtest Cidade"
      unique_id: speedtest_servidor_cidade
      state: >
        {% set server = state_attr('sensor.speedtest_dados', 'server') %}
        {{ server.name if server and server.name is defined else 'Desconhecida' }}
      icon: mdi:city

    - name: "Speedtest País"
      unique_id: speedtest_servidor_pais
      state: >
        {% set server = state_attr('sensor.speedtest_dados', 'server') %}
        {% if server and server.country is defined %}
          {{ server.country }}
        {% else %}
          Desconhecido
        {% endif %}
      icon: mdi:flag

    - name: "Speedtest Distância"
      unique_id: speedtest_servidor_distancia
      state: >
        {% set server = state_attr('sensor.speedtest_dados', 'server') %}
        {{ server.d | round(1) if server and server.d is defined else none }}
      unit_of_measurement: "km"
      icon: mdi:map-marker-distance
      state_class: measurement

    - name: "Speedtest Latência Servidor"
      unique_id: speedtest_servidor_latencia
      state: >
        {% set server = state_attr('sensor.speedtest_dados', 'server') %}
        {{ server.latency | round(2) if server and server.latency is defined else none }}
      unit_of_measurement: "ms"
      icon: mdi:timer-outline
      device_class: duration
      state_class: measurement

    - name: "Último Speedtest"
      unique_id: speedtest_ultimo_teste
      state: >
        {% if states.sensor.speedtest_dados.last_changed is defined %}
          {{ as_timestamp(states.sensor.speedtest_dados.last_changed) | timestamp_custom('%d/%m %H:%M') }}
        {% else %}
          Nunca executado
        {% endif %}
      icon: mdi:clock-outline

    - name: "Servidor Speedtest Atual"
      state: >
        {% set opt = states('input_select.speedtest_server') %}
        {% if opt.startswith('Auto') %}
          Automático
        {% else %}
          {{ opt.split(' - ')[1] }}
        {% endif %}
      icon: mdi:server-network
